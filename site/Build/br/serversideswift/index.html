<!doctype html>
<html data-bs-theme="auto" lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta content="Swift no Linux √© uma √°rea pouco explorada pelo desenvolvedor de plataformas Apple, mas pode ser uma ferramenta muito √∫til e uma fonte de conhecimento imensa, e que vale muito a pena de se aprender." name="description" />
    <meta content="Mauricio Cardozo" name="author" />
    <meta content="Ignite v0.2.1" name="generator" />
    <title>Vamos falar de Swift no Linux? ‚Äì Mauricio Cardozo</title>
    <link href="https://mauriciocardozo.me/br/serversideswift" rel="canonical" />
    <meta content="Mauricio Cardozo" property="og:site_name" />
    <meta content="https://mauriciocardozo.me/serverswift/tux.png" property="og:image" />
    <meta content="https://mauriciocardozo.me/serverswift/tux.png" name="twitter:image" />
    <meta content="Vamos falar de Swift no Linux?" property="og:title" />
    <meta content="Vamos falar de Swift no Linux?" name="twitter:title" />
    <meta content="Swift no Linux √© uma √°rea pouco explorada pelo desenvolvedor de plataformas Apple, mas pode ser uma ferramenta muito √∫til e uma fonte de conhecimento imensa, e que vale muito a pena de se aprender." property="og:description" />
    <meta content="Swift no Linux √© uma √°rea pouco explorada pelo desenvolvedor de plataformas Apple, mas pode ser uma ferramenta muito √∫til e uma fonte de conhecimento imensa, e que vale muito a pena de se aprender." name="twitter:description" />
    <meta content="https://mauriciocardozo.me/br/serversideswift" property="og:url" />
    <meta content="mauriciocardozo.me" name="twitter:domain" />
    <meta content="summary_large_image" name="twitter:card" />
    <meta content="on" name="twitter:dnt" />
    <meta content="article" name="og:type" />
    <meta content="pt-BR" name="og:locale" />
    <meta content="Swift no Linux √© uma √°rea pouco explorada pelo desenvolvedor de plataformas Apple, mas pode ser uma ferramenta muito √∫til e uma fonte de conhecimento imensa, e que vale muito a pena de se aprender." property="og:description" />
    <link href="/css/style.css" rel="stylesheet" />
  </head>
  <body class="container">
    <nav>
      <div class="site-navigation">
        <a href="/" id="title" class="inverted link-plain link-underline link-underline-opacity-100 link-underline-opacity-100-hover"><p style="font-weight: 500">MC</p></a>
        <ul>
          <li><a href="/" class="inverted link-plain link-underline link-underline-opacity-100 link-underline-opacity-100-hover m-0"><p>artigos</p></a></li>
          <li><a href="/apps" class="inverted link-plain link-underline link-underline-opacity-100 link-underline-opacity-100-hover m-0"><p>apps</p></a></li>
          <li><a href="/me" class="inverted link-plain link-underline link-underline-opacity-100 link-underline-opacity-100-hover m-0"><p>contato</p></a></li>
          <li><a href="https://nsbrazil.com" class="inverted link-plain link-underline link-underline-opacity-100 link-underline-opacity-100-hover m-0"><p>NSBrazil</p></a></li>
          <li><a href="/en" class="inverted link-plain link-underline link-underline-opacity-100 link-underline-opacity-100-hover m-0"><p>üá∫üá∏</p></a></li>
        </ul>
      </div>
    </nav>
    <main>
      <div class="content">
        <div>
          <article>
            <img alt="" src="/images/serverswift/tux.png" class="rounded" />
            <h1 style="margin-bottom: 0">Vamos falar de Swift no Linux?</h1>
            <p></p>
            <p>Swift no Linux √© uma √°rea pouco explorada pelo desenvolvedor de plataformas Apple, mas pode ser uma ferramenta muito √∫til e uma fonte de conhecimento imensa, e que vale muito a pena de se aprender.</p>
            <p>Escrever o c√≥digo todos n√≥s j√° entendemos bem, e ver o resultado da nossa cria√ß√£o n√£o √© muito diferente das outras plataformas quando estamos no servidor, mas uma coisa que eu pessoalmente sempre tive muito problema √©: Como eu fa√ßo o meu c√≥digo ficar dispon√≠vel para outras pessoas? A gente j√° sabe como subir um app na App Store, mas e subir um servi√ßo aberto na internet? Existem tantas formas, todas corretas, cada uma de seu jeito e √© quase imposs√≠vel escolher uma.</p>
            <h2>O Projeto</h2>
            <p>Eu criei o <a href="https://t.me/F1LandinhoBot">@F1LandinhoBot</a> com o intuito de me ajudar a lembrar os hor√°rios das corridas da F√≥rmula 1 num grupo de amigos, acessando a API do Telegram e mandando mensagens para que a gente n√£o perdesse o hor√°rio de uma sess√£o sequer das corridas.</p>
            <img src="/images/serverswift/telegram.png" />
            <p>E funcionou tudo bem tranquilo rodando direto no meu Mac, mas eu n√£o quero deixar o meu Mac ligado o tempo todo, rodando esse c√≥digo pro bot funcionar, e n√£o quero nem pensar em como eu vou garantir que ele vai funcionar o tempo todo. Onde moro, quedas de energia s√£o bem comuns, e isso me parece um desperd√≠cio de processamento do meu computador de qualquer forma.</p>
            <p>Ent√£o resolvi colocar esse c√≥digo para rodar no meu servidor na Amazon, que eu j√° tenho faz uns anos rodando um <a href="https://quake.host">servidor de Quake</a>, ent√£o n√£o precisaria desembolsar nenhum centavo a mais do que eu j√° pago por ele pra colocar o servi√ßo no ar. O setup do Swift no Linux est√° todo detalhado no <a href="https://swift.org">Swift.org</a> e apesar de um pouco trabalhoso, √© f√°cil de seguir. Clonei o c√≥digo do GitHub e eu n√£o estava esperando o que vinha a seguir:</p>
            <img src="/images/serverswift/wont-build.png" />
            <p class="center muted caption">OpenCombine √© uma biblioteca feita especificamente pra gente usar o Combine no Linux, como assim ela n√£o existe? Desde quando URLSession √© um AnyObject?</p>
            <h2>Swift no Linux</h2>
            <p>Existem algumas lombadas durante o caminho do Swift no servidor que s√£o raramente mencionadas, principalmente porque s√£o abstra√≠das pelos frameworks famosos, mas que voc√™ vai encontrar bem r√°pido se for pelo caminho de escrever o c√≥digo "puro". Todas elas existem por conta do fato de que o Swift no Mac n√£o traz as mesmas bibliotecas que o Swift no Linux. O Foundation, que a gente est√° bastante acostumado a usar no mundo Apple n√£o √© o mesmo Foundation que existe no Linux, e isso <a href="https://forums.swift.org/t/what-are-best-practices-to-write-a-linux-software-on-macos/">n√£o √© documentado</a> em lugar algum. √â um problema que <a href="https://www.swift.org/blog/future-of-foundation/">n√£o deve durar muito tempo</a>, mas ainda √© um problema.</p>
            <img src="/images/serverswift/urlsession.png" />
            <p class="center muted caption">O URLSession fica em uma biblioteca completamente diferente no Linux, que nem existe no macOS!</p>
            <h2>Publicando o nosso trabalho</h2>
            <p>Resolvidos esses problemas, tenho meu projeto compilando e rodando no servidor, finalmente! Mas e agora, como que eu deixo ele rodando l√°? N√£o posso simplesmente fechar o ssh no meu terminal, porque ele vai parar a execu√ß√£o do c√≥digo. Para resolver esse problema, eu utilizei o <code>systemd</code>, que √© o gerenciador de servi√ßos padr√£o do Ubuntu.</p>
            <p>O meu arquivo de configura√ß√£o dele √© bem simples, eu pedi pro GPT criar uma base e fui customizando com as necessidades que eu tinha, tipo as minhas vari√°veis de ambiente (n√£o coloquem elas direto no seu c√≥digo!) e o que o meu servi√ßo teria de fazer caso acontecesse um problema.</p>
            <pre class="splash"><code>[<span class="type">Unit</span>]
    <span class="type">Description</span>=<span class="type">Landinho</span> formula one schedule telegram bot
    <span class="type">After</span>=network-online.<span class="property">target</span>

    [<span class="type">Service</span>]
    <span class="type">Type</span>=simple
    <span class="type">User</span>=ubuntu
    <span class="type">WorkingDirectory</span>=/home/ubuntu/<span class="type">LandinhoBot<br /> ExecStart</span>=/home/ubuntu/swift/swift-<span class="number">5.7.3</span>-<span class="type">RELEASE</span>-ubuntu22.<span class="number">04</span>/usr/bin/swift run
    <span class="type">Environment</span>=<span class="string">"TELEGRAM_TOKEN=6103171:AAHrN7p7rTJPgeNoeYRo"</span>
    <span class="type">Environment</span>=‚Äú<span class="type">DEBUG_CHAT</span>=-<span class="string">123131234"</span>
    <span class="type">Restart</span>=always

    [<span class="type">Install</span>]
    <span class="type">WantedBy</span>=multi-user.<span class="property">target</span></code></pre>
            <p>Depois disso, ainda preciso entrar no servidor, baixar o c√≥digo, compilar e rodar o servi√ßo. Esse processo todo √© muito chato de se fazer, e como n√£o √© parte do nosso dia a dia, √© at√© capaz de esquecermos como s√£o todos esses passos, ent√£o escrevi um script de deploy bem simples, para facilitar o processo. Ele baixa o c√≥digo, compila e reinicia o servi√ßo:</p>
            <pre class="splash"><code>#!/bin/bash

git fetch
git pull origin main
(
  cd telegram
  swift build
  sudo systemctl restart landinho.<span class="property">service</span>
)</code></pre>
            <p>Mas eu ainda tenho que entrar no servidor, rodar o script e ver se t√° tudo ok. D√° pra deixar melhor. Para resolver isso, depois de conversar com um amigo que √© full-stack, decidi ir para o caminho mais simples poss√≠vel: Automatizar o processo que eu j√° estava fazendo manualmente, pelo GitHub Actions.</p>
            <pre class="splash"><code>on:
  push:
    branches:
    - main
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: configure-ssh
      run: |
          mkdir -p ~/.<span class="property">ssh</span>/
          echo <span class="string">"$key"</span> &gt; ~/.<span class="property">ssh</span>/server.<span class="property">key</span>
          chmod <span class="number">400</span> ~/.<span class="property">ssh</span>/server.<span class="property">key</span>
          cat &gt;&gt;~/.<span class="property">ssh</span>/config &lt;&lt;<span class="type">END<br /> Host</span> server
            <span class="type">HostName</span> <span class="property">$host</span>
            <span class="type">User</span> <span class="property">$username</span>
            <span class="type">IdentityFile</span> ~/.<span class="property">ssh</span>/server.<span class="property">key</span>
            <span class="type">StrictHostKeyChecking</span> no
          <span class="type">END</span>
    - name: run-deploy-script
      run: ssh server 'cd <span class="type">LandinhoBot</span>; sh deploy.<span class="property">sh</span>'
    env:
      host: ${% raw %}{{secrets.<span class="type">SSH_HOST</span>}}{% endraw %}
      username: ${% raw %}{{secrets.<span class="type">SSH_USERNAME</span>}}{% endraw %}
      key: ${% raw %}{{secrets.<span class="type">SSH_KEY</span>}}{% endraw %}</code></pre>
            <p>Importante agradecer o <a href="https://twitter.com/flpms">@flpms</a>, que √© o amigo que menciono durante o artigo. A parte da configura√ß√£o que cria o arquivo de configura√ß√£o do SSH para o GitHub Actions √© de autoria dele.</p>
            <p>Dissecando a configura√ß√£o do Actions, a gente tem um job que vai ser executado toda vez que acontecer um push na minha branch <code>main</code>, com um passo pra configurar o SSH e um passo para executar o nosso script de deploy.</p>
            <p>E √© isso! Desse jeito voc√™ consegue automatizar a execu√ß√£o do seu c√≥digo em qualquer m√°quina Linux que voc√™ tenha acesso ao terminal. Mas existe uma outra alternativa:</p>
            <h2>Platform as a Service</h2>
            <p>Um jeito muito mais f√°cil de se realizar esse processo todo √© utilizando uma plataforma como o <a href="https://render.com">Render</a> (ou outros milhares de servi√ßos que fazem a mesma coisa), que vai abstrair todo o processo de configurar o ambiente, realizar o deploy quando houver um merge, e vai te dar outras regalias, como backups de banco de dados e etc. Essa facilidade toda tem o seu custo ($), e caso voc√™ queira subir outro servi√ßo, os custos v√£o subir bem mais r√°pido.</p>
            <img src="/images/serverswift/render.png" />
            <p>N√£o tem muito o que ficar falando sobre essas plataformas, cada uma vai ter suas particularidades, mas √© uma alternativa que eu gosto muito de usar! Quanto menos tempo a gente gasta na infraestrutura, mais a gente pode investir no produto em si, e isso √© o que importa no final. At√© a pr√≥xima!</p>
            <p></p>
          </article>
        </div>
      </div>
    </main>
  </body>
</html>