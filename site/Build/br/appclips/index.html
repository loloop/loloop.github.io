<!doctype html>
<html data-bs-theme="auto" lang="pt-BR">
  <head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1" name="viewport" />
    <meta content="Neste artigo conto como foi a experi√™ncia de criar um App Clip para o app do maior evento de plataformas Apple do Brasil, e te falo como √© f√°cil fazer o seu pr√≥prio!" name="description" />
    <meta content="Mauricio Cardozo" name="author" />
    <meta content="Ignite v0.2.1" name="generator" />
    <title>Criando o seu primeiro App Clip ‚Äì Mauricio Cardozo</title>
    <link href="https://mauriciocardozo.me/br/appclips" rel="canonical" />
    <meta content="Mauricio Cardozo" property="og:site_name" />
    <meta content="https://mauriciocardozo.me/appclips/header.png" property="og:image" />
    <meta content="https://mauriciocardozo.me/appclips/header.png" name="twitter:image" />
    <meta content="Criando o seu primeiro App Clip" property="og:title" />
    <meta content="Criando o seu primeiro App Clip" name="twitter:title" />
    <meta content="Neste artigo conto como foi a experi√™ncia de criar um App Clip para o app do maior evento de plataformas Apple do Brasil, e te falo como √© f√°cil fazer o seu pr√≥prio!" property="og:description" />
    <meta content="Neste artigo conto como foi a experi√™ncia de criar um App Clip para o app do maior evento de plataformas Apple do Brasil, e te falo como √© f√°cil fazer o seu pr√≥prio!" name="twitter:description" />
    <meta content="https://mauriciocardozo.me/br/appclips" property="og:url" />
    <meta content="mauriciocardozo.me" name="twitter:domain" />
    <meta content="summary_large_image" name="twitter:card" />
    <meta content="on" name="twitter:dnt" />
    <meta content="article" name="og:type" />
    <meta content="pt-BR" name="og:locale" />
    <meta content="Neste artigo conto como foi a experi√™ncia de criar um App Clip para o app do maior evento de plataformas Apple do Brasil, e te falo como √© f√°cil fazer o seu pr√≥prio!" property="og:description" />
    <link href="/css/style.css" rel="stylesheet" />
  </head>
  <body class="container">
    <nav>
      <div class="site-navigation">
        <a href="/" id="title" class="inverted link-plain link-underline link-underline-opacity-100 link-underline-opacity-100-hover"><p style="font-weight: 500">MC</p></a>
        <ul>
          <li><a href="/" class="inverted link-plain link-underline link-underline-opacity-100 link-underline-opacity-100-hover m-0"><p>artigos</p></a></li>
          <li><a href="/apps" class="inverted link-plain link-underline link-underline-opacity-100 link-underline-opacity-100-hover m-0"><p>apps</p></a></li>
          <li><a href="/me" class="inverted link-plain link-underline link-underline-opacity-100 link-underline-opacity-100-hover m-0"><p>contato</p></a></li>
          <li><a href="https://nsbrazil.com" class="inverted link-plain link-underline link-underline-opacity-100 link-underline-opacity-100-hover m-0"><p>NSBrazil</p></a></li>
          <li><a href="/en" class="inverted link-plain link-underline link-underline-opacity-100 link-underline-opacity-100-hover m-0"><p>üá∫üá∏</p></a></li>
        </ul>
      </div>
    </nav>
    <main>
      <div class="content">
        <div>
          <article>
            <img alt="" src="/images/appclips/header.png" class="rounded" />
            <h1>Criando o seu primeiro App Clip</h1>
            <p></p>
            <p>Na WWDC 2020, um dos an√∫ncios mais interessantes que acabou passando batido foi o surgimento dos App Clips. App Clips s√£o pequenos peda√ßos de apps que podem ser baixados sem a necessidade de passar por toda a burocracia de usar a App Store. Foram feitos para intera√ß√µes r√°pidas e simples, mas podem ser uma √≥tima porta de entrada do usu√°rio para conhecer o seu app!</p>
            <p>Os App Clips tem um tamanho limite de 10MB por Clip, ent√£o √© importante escolher bem a funcionalidade que voc√™ quer apresentar para o seu usu√°rio nele! Neste artigo, vamos ver como foi criar o App Clip da NSBrazil, que mostra o cronograma de atividades do evento para o usu√°rio. O importante √© escolher uma funcionalidade que pode ser utilizada "na hora" pelo usu√°rio, pois o App Clip √© deletado ap√≥s 30 dias e n√£o vira um √≠cone na home screen do usu√°rio para que ele acesse o aplicativo depois. Alguns exemplos interessantes s√£o fluxos de pagamento (voc√™ pode usar o Apple Pay para deixar a intera√ß√£o ainda mais simples!) ou um trial de uma funcionalidade do seu app, para convencer o usu√°rio a instalar a experi√™ncia completa.</p>
            <img src="/images/appclips/chibi-clip.png" height="300px" />
            <p class="center muted caption">Testa esse Clip! Aposto que voc√™ n√£o vai se decepcionar</p>
            <p>Come√ßando do come√ßo, os App Clips s√£o um app como qualquer outro, apenas com algumas limita√ß√µes, ent√£o para cri√°-los √© bem simples, basta criar um target novo no seu projeto com o App Clip desejado. Como √© poss√≠vel criar mais de um clip por app, √© interessante utilizar um bundle identifier que vai representar a funcionalidade do seu clip. N√£o se preocupe muito com isso, porque d√° pra criar e configurar outros depois :) No app da NSBrazil, criei como <code>com.cocoaheads.conf.baseClip</code></p>
            <img src="/images/appclips/creating-clip-target.png" />
            <p>Uma das coisas mais legais dos App Clips √© que eles s√£o obrigatoriamente apps de iOS 14+, ent√£o n√≥s podemos usar o lifecycle de um app SwiftUI ao inv√©s do cl√°ssico App/SceneDelegate do UIKit. Tamb√©m √© poss√≠vel usar eles, claro, mas se a gente pode optar pelo processo mais simples, por que n√£o?</p>
            <pre class="splash"><code><span class="keyword">@main<br />struct</span> NSClipApp: <span class="type">App</span> {

    <span class="comment">// O FeedViewModel carrega as informa√ß√µes necess√°rias para mostrar<br /> // a agenda do evento dentro do App Clip.<br /> // Dentro de um App Clip, √© poss√≠vel fazer requests para baixar<br /> // todo o conte√∫do necess√°rio para que ele funcione, mesmo que isso<br /> // supere o limite de 10MB</span>
    <span class="keyword">@StateObject var</span> feedModel = <span class="type">FeedViewModel</span>()

    <span class="keyword">var</span> body: <span class="keyword">some</span> <span class="type">Scene</span> {
        <span class="type">WindowGroup</span> {
            <span class="type">ZStack</span> {
                <span class="keyword">switch</span> feedModel.<span class="property">isLoading</span> {
                <span class="keyword">case</span> .<span class="dotAccess">loading</span>:
                    <span class="type">ActivityIndicatorView</span>()
                <span class="keyword">case</span> .<span class="dotAccess">loaded</span>:
                    loadedBody
                <span class="keyword">case</span> .<span class="dotAccess">failed</span>:
                    errorBody
                }
            }
        }
    }

    <span class="keyword">var</span> loadedBody: <span class="keyword">some</span> <span class="type">View</span> {
        <span class="type">VStack</span> {
            <span class="type">DownloadCallToAction</span>()
                .<span class="call">padding</span>(.<span class="dotAccess">bottom</span>)
            <span class="type">ScheduleListView</span>(viewModel: feedModel)
        }
    }

    <span class="keyword">var</span> errorBody: <span class="keyword">some</span> <span class="type">View</span> {
        <span class="type">VStack</span>(spacing: <span class="number">20</span>) {
            <span class="type">Text</span>(<span class="string">"Algo deu errado"</span>)
                .<span class="call">font</span>(<span class="type">Font</span>.<span class="property">title</span>.<span class="call">bold</span>())

            <span class="type">Button</span>(action: {
                <span class="keyword">self</span>.<span class="property">feedModel</span>.<span class="call">fetchInfo</span>()
            }, label: {
                <span class="type">Text</span>(<span class="string">"Tentar novamente"</span>)
            })
        }
    }
}</code></pre>
            <p>Fora isso, podemos lidar com o c√≥digo do Clip de 3 formas: Criar tudo de novo pro Clip, marcando os arquivos para serem compilados junto com o target do clip ou embeddando um framework que usamos no app principal dentro do clip. Criando tudo de novo, corremos o risco de duplicar bugs ou esquecer da evolu√ß√£o da funcionalidade, sem contar que a√≠ √© mais um app pra se manter, mas √© poss√≠vel, caso seja necess√°rio.</p>
            <p>No clip da NSBrazil, existe uma <code>View</code> que s√≥ existe dentro do c√≥digo do App Clip, porque n√£o faria sentido usar ela dentro do app normal. Com frameworks, podemos reaproveitar todo o c√≥digo necess√°rio, que j√° est√° modularizado, e assim tamb√©m podemos criar diversos clips sem correr o risco de esquecer de marcar as flags de compila√ß√£o no Xcode toda vez que criarmos arquivos novos. No NSBrazil, o approach escolhido foi o mais simples, de marcar os arquivos necess√°rios para compila√ß√£o no Clip, pela facilidade de se fazer isso num primeiro momento, mas a inten√ß√£o √© de separar tudo que for necess√°rio em um framework, para n√£o prejudicar a evolu√ß√£o do app.</p>
            <p>Escolhendo esse approach de compilar os mesmos arquivos para targets diferentes, as vezes ainda precisamos fazer altera√ß√µes espec√≠ficas para a experi√™ncia do nosso clip. Para esses casos, podemos criar uma compiler flag que vai incluir o c√≥digo apenas na compila√ß√£o do clip, em <code>Swift Compiler - Custom Flags</code> do target do App Clip, adicionando a <code>-D &lt;NOMEDASUAFLAG&gt;</code>:</p>
            <img src="/images/appclips/swiftflag.png" />
            <p>Com isso, podemos escrever nosso c√≥digo incluindo as flags quando necess√°rio, como por exemplo:</p>
            <pre class="splash"><code><span class="comment">/* Snippet de c√≥digo da `TalkView` da agenda do app */</span>

<span class="type">VStack</span>(alignment: .<span class="dotAccess">leading</span>, spacing: <span class="number">5</span>) {
    <span class="type">Spacer</span>().<span class="call">frame</span>(maxHeight: <span class="number">5</span>)
    <span class="type">Text</span>(feedItem.<span class="property">name</span>)
        .<span class="call">font</span>(.<span class="dotAccess">headline</span>)

    <span class="type">Text</span>(feedItem.<span class="property">speaker</span>)
        .<span class="call">lineLimit</span>(<span class="number">3</span>)
        .<span class="call">font</span>(.<span class="call">system</span>(size: <span class="number">14</span>))
        .<span class="call">lineSpacing</span>(<span class="number">4</span>)

    <span class="type">Text</span>(<span class="call">date</span>())
        .<span class="call">font</span>(.<span class="dotAccess">callout</span>)
        .<span class="call">fontWeight</span>(.<span class="dotAccess">bold</span>)
        .<span class="call">foregroundColor</span>(.<span class="dotAccess">gray</span>)

    <span class="preprocessing">#if APPCLIP</span>
        <span class="type">Text</span>(<span class="string">"I am running inside the App Clip!"</span>)
    <span class="preprocessing">#endif</span>
    <span class="type">Spacer</span>().<span class="call">frame</span>(maxHeight: <span class="number">5</span>)
}</code></pre>
            <p>E a√≠, compilando tanto o app quanto o App Clip, podemos ver o resultado:</p>
            <img src="/images/appclips/clipcomparison.png" />
            <h2>Invocando e testando o App Clip</h2>
            <p>Com o nosso c√≥digo pronto e organizado, agora precisamos testar o clip. Rodando pelo Xcode, o clip se comporta com o mesmo processo de um app comum no simulador, mas essa n√£o √© a experi√™ncia completa que o usu√°rio vai ter quando for invocar o clip, n√£o √©? Para isso, precisamos associar o dom√≠nio da URL que usaremos para invocar nas capabilities do target do clip:</p>
            <img src="/images/appclips/assoc-domains.png" />
            <p>E tamb√©m precisamos criar uma Local Experience no menu de Desenvolvedor (<code>Desenvolvedor -&gt; Local Experiences -&gt; Register Local Experience</code>) do aparelho:</p>
            <img src="/images/appclips/local-experience.png" />
            <p class="center muted caption">Caso o menu Desenvolvedor n√£o esteja aparecendo nos Ajustes, instale um app no seu device pelo Xcode</p>
            <p>Assim que esse menu for preenchido, podemos abrir a c√¢mera ou o Scanner de c√≥digos do sistema e testar o nosso App Clip!</p>
            <p>Caso queira testar em outros devices, √© poss√≠vel arquivar uma vers√£o para instala√ß√£o <em>ad-hoc</em> ou subir o app para o <code>TestFlight</code>, e a√≠, s√≥ seguir os mesmos passos de criar a experi√™ncia local.</p>
            <img src="/images/appclips/testflight.png" />
            <p>Uma das limita√ß√µes mais importantes do App Clip √© o tamanho do app, e √© bem f√°cil da gente checar isso tamb√©m, basta arquivar o App Clip para instala√ß√µes <em>ad-hoc</em> e marcar essas op√ß√µes:</p>
            <img src="/images/appclips/thinning.png" />
            <p>Dentro da pasta que o Xcode criou pra gente, existe um arquivo chamado <code>App Thinning Size Report.txt</code>, com o tamanho do seu clip para cada variante do App Thinning. Procure pela variante <code>Universal</code> do app e verifique o tamanho <strong>uncompressed</strong> dela. Esse √© o tamanho que n√£o pode passar de 10MB.</p>
            <p>{% highlight plain %} Variant: NSClip.ipa Supported variant descriptors: Universal App + On Demand Resources size: 333 KB compressed, 667 KB uncompressed App size: 333 KB compressed, 667 KB uncompressed On Demand Resources size: Zero KB compressed, Zero KB uncompressed {% endhighlight %}</p>
            <h2>Publicando o App Clip</h2>
            <p>Agora que estamos com tudo pronto do lado do app, precisamos criar formas de acessar o nosso App Clip! Os App Clips podem ser acessados por meio de tags NFC, QR Codes comuns, banners em websites, c√≥digos de App Clip, pelo app Mapas e sugest√µes da Siri. Configurando a URL do dom√≠nio, podemos cobrir 4 destes casos, excluindo apenas os Mapas e a Siri.</p>
            <p>Para isso, √© necess√°rio configurar o dom√≠nio no seu servidor, colocando um arquivo JSON com o seguinte caminho na raiz do seu site: <code>.well-known/apple-app-site-association</code>.</p>
            <pre class="splash"><code>{
    <span class="string">"appclips"</span>: {
        <span class="string">"apps"</span>: [
            <span class="string">"TEAMIDENTIFIER.bundle.identifier.do.seu.clip"</span>
        ]
    }
}</code></pre>
            <p>Se voc√™ j√° usa Universal Links no seu app, √© mais simples ainda, s√≥ adicionar a chave referente aos <code>appclips</code> no arquivo, e caso voc√™ tenha feito mais de um clip, √© s√≥ colocar todos eles dentro do array de apps.</p>
            <p><strong>Aten√ß√£o</strong>: Caso voc√™ esteja hospedando o seu site com o GitHub Pages, assim como fazemos na NSBrazil, n√£o √© poss√≠vel adicionar o arquivo apenas criando o JSON na raiz. Resolvemos esse problema no NSBrazil utilizando o CloudFlare como CDN, e com os CloudFlare Workers, interceptar a chamada para o caminho do arquivo e executar c√≥digo JavaScript para retornar o JSON correto:</p>
            <pre class="splash"><code><span class="call">addEventListener</span>('fetch', event =&gt; {
  event.<span class="call">respondWith</span>(<span class="call">handleRequest</span>(event.<span class="property">request</span>))
})

<span class="comment">/**<br /> * Since GitHub Pages does not support .well-known root files,<br /> * we have to add the Apple App Site Association file via a worker<br /> */</span>
<span class="keyword">async</span> function <span class="call">handleRequest</span>(request) {
  <span class="keyword">let</span> aasa = <span class="type">JSON</span>.<span class="call">stringify</span>({
    appclips: {
      apps: [<span class="string">"V45SL99ZK4.com.cocoaheadsbr.conf.baseClip"</span>]
    }
  })
  <span class="keyword">return</span> new <span class="type">Response</span>(aasa, {
    headers: {
      <span class="string">"content-type"</span>: <span class="string">"application/json"</span>
    },
    status: <span class="number">200</span>
  })
}</code></pre>
            <p>A partir da√≠, podemos criar as imagens de acesso, que podem ser tanto um QR Code comum que cont√©m a URL, ou o App Clip Code especializado da Apple, que pode ser criado pelo App Store Connect, que te d√° a op√ß√£o de criar um quando voc√™ sobe o app, ou com a ferramenta de linha de comando <a href="https://developer.apple.com/app-clips/resources/">App Clip Code Generator</a>. Tamb√©m d√° pra criar um Smart App Banner que leva o usu√°rio direto para o seu App Clip, desta maneira:</p>
            <pre class="splash"><code>&lt;!-- <span class="type">Voc√™</span> pode encontrar o `app-id` do seu app na p√°gina de informa√ß√µes dele, dentro <span class="keyword">do</span> <span class="type">AppStore Connect</span>  --&gt;
&lt;meta name=<span class="string">"apple-itunes-app"</span>
      content=<span class="string">"app-id=1180455342, app-clip-bundle-id=com.cocoaheads.conf.baseClip"</span>&gt;</code></pre>
            <img src="/images/appclips/nsclip.svg" height="300px" />
            <p>O √∫ltimo passo √© criar a experi√™ncia no AppStore Connect, preencher todos os detalhes para formar o card do clip, e esperar at√© 48h para que ele se propague. (OBS: Essa parte s√≥ vai aparecer no seu Connect depois que voc√™ subir um build que cont√©m um App Clip)</p>
            <img src="/images/appclips/appstore.png" />
            <p>E √© isso! Nosso App Clip est√° pronto para ser compartilhado com o mundo. Se voc√™ quiser conferir o projeto completo do app da NSBrazil, √© s√≥ entrar l√° no <a href="https://github.com/CocoaHeadsConference/CHConferenceApp">Reposit√≥rio do Projeto</a>, completamente feito com SwiftUI, com target a partir do iOS13!</p>
            <p></p>
          </article>
        </div>
      </div>
    </main>
  </body>
</html>