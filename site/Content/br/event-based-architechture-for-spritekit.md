---
title: Arquitetura baseada em eventos para SpriteKit
thumbnail: 
description: Vamos dar uma olhada em como podemos facilitar o desenvolvimento de apps com SpriteKit
published: true
header: /images/spritekit/logo.png
layout: ArticleLayout
date: 2020-07-19 00:00:00
---

Este artigo é um pedaço do que apresentei na [talk que dei no CocoaHeads ES em Vitória](https://www.youtube.com/watch?v=69lGgGLGoJQ), realizado na Brooder, em novembro de 2019, "Criando o seu primeiro jogo com SpriteKit". Lá, falo um pouco mais sobre os objetos, funcionalidades e lifecycle do SpriteKit em si, além de introduzir a arquitetura baseada em eventos.

O SpriteKit é um framework desenvolvido pela Apple para a criação de jogos de alta performance em 2D. Como ex-desenvolvedor de jogos, este framework me atraiu naturalmente assim que comecei a estudar Swift e desenvolver apps, mas como desenvolvia com a Unity, que é bastante opinativa em sua arquitetura, fiquei um pouco perdido ao tentar criar experiências com ele. A talk que fiz e por consequência este artigo são o resultado de uma tentativa de deixar o desenvolvimento com SpriteKit mais estruturado para facilitar o seu entendimento.

O jogo de exemplo que desenvolvi para expor esta arquitetura é um infinite runner bem simples, que conta com todos os elementos básicos que se espera de um jogo: uma personagem que tem movimentos, ações, animações, pontos de vida, sons, que existe em um ambiente animado com inimigos que reagem a personagem e tentam acabar com a existência dela, e claro, com uma boa trilha sonora de fundo também.

![](spritekit/game.jpeg)
<p class="center muted caption">Toda a arte deste jogo é composta de assets de domínio público, criados pelo ótimo <a href="https://kenney.nl">Kenney</a></p>

O objeto básico do SpriteKit é o `SKNode`, todos os objetos que vão ser utilizados no contexto dele são do mesmo tipo, e quando juntos, formam uma árvore de nós pais e filhos, com métodos prontos para acessá-los.

<div class="appledoc">
    <div class="left-col">
        Accessing Related Nodes
    </div>
    <div class="right-col">
        <div class="var">
            <code>var <span class="blue">scene</span>: SKScene?</code>
            <span class="description">The scene node that contains this node.</span>
        </div>
        <div class="var">
            <code>var <span class="blue">parent</span>: SKNode?</code>
            <span class="description">The node's parent node.</span>
        </div>
        <div class="var">
            <code>var <span class="blue">children</span>: [SKNode]</code>
            <span class="description">The node's children.</span>
        </div>
    </div>
</div>

<svg viewBox="0 0 709 709" version="1.1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
    <!-- Generator: Sketch 53.2 (72643) - https://sketchapp.com -->
    <title>Artboard</title>
    <desc>Created with Sketch.</desc>
    <g id="Artboard" stroke="none" stroke-width="1" fill="none" fill-rule="evenodd">
        <g id="Group" transform="translate(54.000000, 89.000000)" fill="#FFFFFF">
            <circle id="Oval-Copy-2" cx="42" cy="40" r="40"></circle>
            <circle id="Oval-Copy-3" cx="42" cy="266" r="40"></circle>
            <circle id="Oval-Copy-4" cx="206" cy="266" r="40"></circle>
            <path id="Line-2" d="M171.248424,178.905278 L94.1715729,101.828427 L91.3431458,99 L97,93.3431458 L99.8284271,96.1715729 L176.905278,173.248424 L189.6332,160.520502 L205.18955,207.18955 L158.520502,191.6332 L171.248424,178.905278 Z" fill-rule="nonzero"></path>
            <circle id="Oval-Copy-7" cx="392" cy="492" r="40"></circle>
            <path id="Line-2-Copy" d="M357.248424,404.905278 L280.171573,327.828427 L277.343146,325 L283,319.343146 L285.828427,322.171573 L362.905278,399.248424 L375.6332,386.520502 L391.18955,433.18955 L344.520502,417.6332 L357.248424,404.905278 Z" fill-rule="nonzero"></path>
            <path id="Line" d="M36.5,163.18955 L36.5,99 L36.5,95 L44.5,95 L44.5,99 L44.5,163.18955 L62.5,163.18955 L40.5,207.18955 L18.5,163.18955 L36.5,163.18955 Z" fill-rule="nonzero"></path>
            <path id="Line-Copy" d="M38.5,389.18955 L38.5,325 L38.5,321 L46.5,321 L46.5,325 L46.5,389.18955 L64.5,389.18955 L42.5,433.18955 L20.5,389.18955 L38.5,389.18955 Z" fill-rule="nonzero"></path>
            <path id="Line-Copy-2" d="M200.5,389.18955 L200.5,325 L200.5,321 L208.5,321 L208.5,325 L208.5,389.18955 L226.5,389.18955 L204.5,433.18955 L182.5,389.18955 L200.5,389.18955 Z" fill-rule="nonzero"></path>
            <path d="M123.542969,48.5117188 C123.542969,47.1835938 124.460938,46.2460938 125.652344,46.2460938 C126.53125,46.2460938 127.253906,46.6171875 128.191406,47.6328125 C129.695312,49.3710938 131.6875,50.2695312 134.011719,50.2695312 C137.136719,50.2695312 138.914062,49.0195312 138.914062,46.8515625 C138.914062,45.0546875 137.664062,43.9414062 134.773438,43.2578125 L130.789062,42.28125 C126.199219,41.2265625 123.914062,38.7851562 123.914062,34.9179688 C123.914062,30.015625 127.78125,26.8320312 133.71875,26.8320312 C136.902344,26.8320312 139.753906,27.75 141.511719,29.3710938 C142.722656,30.4648438 143.367188,31.7148438 143.367188,32.9453125 C143.367188,34.1757812 142.507812,35.015625 141.238281,35.015625 C140.417969,35.015625 139.714844,34.6640625 139.089844,33.8828125 C137.898438,32.1054688 136.101562,31.109375 133.796875,31.109375 C131.023438,31.109375 129.246094,32.4375 129.246094,34.5078125 C129.246094,36.1679688 130.457031,37.3398438 132.9375,37.90625 L136.941406,38.8632812 C141.824219,39.9765625 144.128906,42.3398438 144.128906,46.265625 C144.128906,51.34375 140.085938,54.5664062 133.71875,54.5664062 C130.261719,54.5664062 127.195312,53.609375 125.4375,51.9492188 C124.207031,50.8164062 123.542969,49.625 123.542969,48.5117188 Z M166.355469,54.1171875 C165.359375,54.1171875 164.519531,53.5898438 163.640625,52.3789062 L156.492188,42.3984375 L153.679688,45.2890625 L153.679688,51.34375 C153.679688,53.1601562 152.742188,54.1953125 151.082031,54.1953125 C149.402344,54.1953125 148.40625,53.140625 148.40625,51.34375 L148.40625,29.9960938 C148.40625,28.1992188 149.363281,27.1445312 151.042969,27.1445312 C152.703125,27.1445312 153.679688,28.1992188 153.679688,29.9960938 L153.679688,39.0195312 L153.972656,39.0195312 L163.777344,28.4726562 C164.578125,27.5742188 165.222656,27.2226562 165.984375,27.2226562 C167.3125,27.2226562 168.328125,28.2382812 168.328125,29.5273438 C168.328125,30.2109375 168.074219,30.6992188 167.234375,31.5976562 L160.417969,39 L167.742188,49.0195312 C168.699219,50.3085938 168.933594,50.8554688 168.933594,51.5976562 C168.933594,53.0820312 167.878906,54.1171875 166.355469,54.1171875 Z M177.957031,51.4023438 C177.957031,53.1601562 177.058594,54.1953125 175.496094,54.1953125 C173.933594,54.1953125 173.015625,53.140625 173.015625,51.4023438 L173.015625,30.328125 C173.015625,28.2382812 173.933594,27.1445312 175.730469,27.1445312 C177,27.1445312 177.742188,27.8671875 178.835938,29.4882812 L189.070312,45.0742188 L189.285156,45.0742188 L189.285156,29.9375 C189.285156,28.1796875 190.183594,27.1445312 191.746094,27.1445312 C193.308594,27.1445312 194.246094,28.1992188 194.246094,29.9375 L194.246094,51.1289062 C194.246094,53.1210938 193.347656,54.1953125 191.667969,54.1953125 C190.398438,54.1953125 189.65625,53.6679688 188.503906,51.9296875 L178.171875,36.1679688 L177.957031,36.1679688 L177.957031,51.4023438 Z M208.328125,32.828125 C213.972656,32.828125 217.878906,36.4023438 217.878906,42.359375 L217.878906,44.8007812 C217.878906,50.953125 213.972656,54.4492188 208.328125,54.4492188 C202.664062,54.4492188 198.757812,50.953125 198.757812,44.8203125 L198.757812,42.3789062 C198.757812,36.4023438 202.664062,32.828125 208.328125,32.828125 Z M208.328125,36.8320312 C205.691406,36.8320312 204.050781,38.9804688 204.050781,42.4765625 L204.050781,44.78125 C204.050781,48.3164062 205.691406,50.4453125 208.328125,50.4453125 C211.003906,50.4453125 212.585938,48.3164062 212.585938,44.78125 L212.585938,42.4765625 C212.585938,38.9804688 211.003906,36.8320312 208.328125,36.8320312 Z M235.085938,50.6992188 C234.421875,52.828125 231.980469,54.2734375 229.011719,54.2734375 C224.265625,54.2734375 221.277344,50.7773438 221.277344,45.1914062 L221.277344,42.0273438 C221.277344,36.421875 224.285156,32.9453125 229.070312,32.9453125 C231.960938,32.9453125 234.1875,34.234375 234.988281,36.3632812 L235.242188,36.3632812 L235.242188,28.6289062 C235.242188,26.8125 236.160156,25.7773438 237.820312,25.7773438 C239.460938,25.7773438 240.398438,26.8125 240.398438,28.6289062 L240.398438,51.3632812 C240.398438,53.1796875 239.5,54.1953125 237.859375,54.1953125 C236.355469,54.1953125 235.4375,53.2773438 235.339844,51.6757812 L235.339844,50.6992188 L235.085938,50.6992188 Z M226.570312,44.6640625 C226.570312,48.1210938 228.152344,50.171875 230.867188,50.171875 C233.542969,50.171875 235.242188,48.140625 235.242188,44.8789062 L235.242188,42.125 C235.242188,39.1171875 233.425781,37.0664062 230.789062,37.0664062 C228.132812,37.0664062 226.570312,39.1367188 226.570312,42.5742188 L226.570312,44.6640625 Z M244.773438,44.9960938 L244.773438,42.3203125 C244.773438,36.65625 248.523438,32.828125 254.089844,32.828125 C259.363281,32.828125 263.09375,36.578125 263.09375,41.6953125 C263.09375,44.0195312 262.429688,44.78125 260.496094,44.78125 L250.007812,44.78125 L250.007812,45.6796875 C250.027344,48.5703125 251.863281,50.4257812 254.929688,50.4257812 C256.53125,50.4257812 257.664062,50.0351562 258.582031,49.2734375 C259.578125,48.5117188 259.929688,48.21875 260.730469,48.21875 C261.804688,48.21875 262.546875,48.9609375 262.546875,50.09375 C262.546875,51.0117188 261.980469,51.890625 261.003906,52.59375 C259.636719,53.7460938 257.273438,54.4492188 254.597656,54.4492188 C248.523438,54.4492188 244.773438,50.875 244.773438,44.9960938 Z M250.007812,41.5195312 L258.171875,41.5195312 L258.171875,41.4804688 C258.171875,38.6484375 256.609375,36.8125 254.167969,36.8125 C251.628906,36.8125 250.007812,38.6875 250.007812,41.4804688 L250.007812,41.5195312 Z" id="SKNode" fill-rule="nonzero"></path>
            <path d="M287.542969,274.511719 C287.542969,273.183594 288.460938,272.246094 289.652344,272.246094 C290.53125,272.246094 291.253906,272.617188 292.191406,273.632812 C293.695312,275.371094 295.6875,276.269531 298.011719,276.269531 C301.136719,276.269531 302.914062,275.019531 302.914062,272.851562 C302.914062,271.054688 301.664062,269.941406 298.773438,269.257812 L294.789062,268.28125 C290.199219,267.226562 287.914062,264.785156 287.914062,260.917969 C287.914062,256.015625 291.78125,252.832031 297.71875,252.832031 C300.902344,252.832031 303.753906,253.75 305.511719,255.371094 C306.722656,256.464844 307.367188,257.714844 307.367188,258.945312 C307.367188,260.175781 306.507812,261.015625 305.238281,261.015625 C304.417969,261.015625 303.714844,260.664062 303.089844,259.882812 C301.898438,258.105469 300.101562,257.109375 297.796875,257.109375 C295.023438,257.109375 293.246094,258.4375 293.246094,260.507812 C293.246094,262.167969 294.457031,263.339844 296.9375,263.90625 L300.941406,264.863281 C305.824219,265.976562 308.128906,268.339844 308.128906,272.265625 C308.128906,277.34375 304.085938,280.566406 297.71875,280.566406 C294.261719,280.566406 291.195312,279.609375 289.4375,277.949219 C288.207031,276.816406 287.542969,275.625 287.542969,274.511719 Z M330.355469,280.117188 C329.359375,280.117188 328.519531,279.589844 327.640625,278.378906 L320.492188,268.398438 L317.679688,271.289062 L317.679688,277.34375 C317.679688,279.160156 316.742188,280.195312 315.082031,280.195312 C313.402344,280.195312 312.40625,279.140625 312.40625,277.34375 L312.40625,255.996094 C312.40625,254.199219 313.363281,253.144531 315.042969,253.144531 C316.703125,253.144531 317.679688,254.199219 317.679688,255.996094 L317.679688,265.019531 L317.972656,265.019531 L327.777344,254.472656 C328.578125,253.574219 329.222656,253.222656 329.984375,253.222656 C331.3125,253.222656 332.328125,254.238281 332.328125,255.527344 C332.328125,256.210938 332.074219,256.699219 331.234375,257.597656 L324.417969,265 L331.742188,275.019531 C332.699219,276.308594 332.933594,276.855469 332.933594,277.597656 C332.933594,279.082031 331.878906,280.117188 330.355469,280.117188 Z M341.957031,277.402344 C341.957031,279.160156 341.058594,280.195312 339.496094,280.195312 C337.933594,280.195312 337.015625,279.140625 337.015625,277.402344 L337.015625,256.328125 C337.015625,254.238281 337.933594,253.144531 339.730469,253.144531 C341,253.144531 341.742188,253.867188 342.835938,255.488281 L353.070312,271.074219 L353.285156,271.074219 L353.285156,255.9375 C353.285156,254.179688 354.183594,253.144531 355.746094,253.144531 C357.308594,253.144531 358.246094,254.199219 358.246094,255.9375 L358.246094,277.128906 C358.246094,279.121094 357.347656,280.195312 355.667969,280.195312 C354.398438,280.195312 353.65625,279.667969 352.503906,277.929688 L342.171875,262.167969 L341.957031,262.167969 L341.957031,277.402344 Z M372.328125,258.828125 C377.972656,258.828125 381.878906,262.402344 381.878906,268.359375 L381.878906,270.800781 C381.878906,276.953125 377.972656,280.449219 372.328125,280.449219 C366.664062,280.449219 362.757812,276.953125 362.757812,270.820312 L362.757812,268.378906 C362.757812,262.402344 366.664062,258.828125 372.328125,258.828125 Z M372.328125,262.832031 C369.691406,262.832031 368.050781,264.980469 368.050781,268.476562 L368.050781,270.78125 C368.050781,274.316406 369.691406,276.445312 372.328125,276.445312 C375.003906,276.445312 376.585938,274.316406 376.585938,270.78125 L376.585938,268.476562 C376.585938,264.980469 375.003906,262.832031 372.328125,262.832031 Z M399.085938,276.699219 C398.421875,278.828125 395.980469,280.273438 393.011719,280.273438 C388.265625,280.273438 385.277344,276.777344 385.277344,271.191406 L385.277344,268.027344 C385.277344,262.421875 388.285156,258.945312 393.070312,258.945312 C395.960938,258.945312 398.1875,260.234375 398.988281,262.363281 L399.242188,262.363281 L399.242188,254.628906 C399.242188,252.8125 400.160156,251.777344 401.820312,251.777344 C403.460938,251.777344 404.398438,252.8125 404.398438,254.628906 L404.398438,277.363281 C404.398438,279.179688 403.5,280.195312 401.859375,280.195312 C400.355469,280.195312 399.4375,279.277344 399.339844,277.675781 L399.339844,276.699219 L399.085938,276.699219 Z M390.570312,270.664062 C390.570312,274.121094 392.152344,276.171875 394.867188,276.171875 C397.542969,276.171875 399.242188,274.140625 399.242188,270.878906 L399.242188,268.125 C399.242188,265.117188 397.425781,263.066406 394.789062,263.066406 C392.132812,263.066406 390.570312,265.136719 390.570312,268.574219 L390.570312,270.664062 Z M408.773438,270.996094 L408.773438,268.320312 C408.773438,262.65625 412.523438,258.828125 418.089844,258.828125 C423.363281,258.828125 427.09375,262.578125 427.09375,267.695312 C427.09375,270.019531 426.429688,270.78125 424.496094,270.78125 L414.007812,270.78125 L414.007812,271.679688 C414.027344,274.570312 415.863281,276.425781 418.929688,276.425781 C420.53125,276.425781 421.664062,276.035156 422.582031,275.273438 C423.578125,274.511719 423.929688,274.21875 424.730469,274.21875 C425.804688,274.21875 426.546875,274.960938 426.546875,276.09375 C426.546875,277.011719 425.980469,277.890625 425.003906,278.59375 C423.636719,279.746094 421.273438,280.449219 418.597656,280.449219 C412.523438,280.449219 408.773438,276.875 408.773438,270.996094 Z M414.007812,267.519531 L422.171875,267.519531 L422.171875,267.480469 C422.171875,264.648438 420.609375,262.8125 418.167969,262.8125 C415.628906,262.8125 414.007812,264.6875 414.007812,267.480469 L414.007812,267.519531 Z" id="SKNode" fill-rule="nonzero"></path>
            <path d="M473.542969,500.511719 C473.542969,499.183594 474.460938,498.246094 475.652344,498.246094 C476.53125,498.246094 477.253906,498.617188 478.191406,499.632812 C479.695312,501.371094 481.6875,502.269531 484.011719,502.269531 C487.136719,502.269531 488.914062,501.019531 488.914062,498.851562 C488.914062,497.054688 487.664062,495.941406 484.773438,495.257812 L480.789062,494.28125 C476.199219,493.226562 473.914062,490.785156 473.914062,486.917969 C473.914062,482.015625 477.78125,478.832031 483.71875,478.832031 C486.902344,478.832031 489.753906,479.75 491.511719,481.371094 C492.722656,482.464844 493.367188,483.714844 493.367188,484.945312 C493.367188,486.175781 492.507812,487.015625 491.238281,487.015625 C490.417969,487.015625 489.714844,486.664062 489.089844,485.882812 C487.898438,484.105469 486.101562,483.109375 483.796875,483.109375 C481.023438,483.109375 479.246094,484.4375 479.246094,486.507812 C479.246094,488.167969 480.457031,489.339844 482.9375,489.90625 L486.941406,490.863281 C491.824219,491.976562 494.128906,494.339844 494.128906,498.265625 C494.128906,503.34375 490.085938,506.566406 483.71875,506.566406 C480.261719,506.566406 477.195312,505.609375 475.4375,503.949219 C474.207031,502.816406 473.542969,501.625 473.542969,500.511719 Z M516.355469,506.117188 C515.359375,506.117188 514.519531,505.589844 513.640625,504.378906 L506.492188,494.398438 L503.679688,497.289062 L503.679688,503.34375 C503.679688,505.160156 502.742188,506.195312 501.082031,506.195312 C499.402344,506.195312 498.40625,505.140625 498.40625,503.34375 L498.40625,481.996094 C498.40625,480.199219 499.363281,479.144531 501.042969,479.144531 C502.703125,479.144531 503.679688,480.199219 503.679688,481.996094 L503.679688,491.019531 L503.972656,491.019531 L513.777344,480.472656 C514.578125,479.574219 515.222656,479.222656 515.984375,479.222656 C517.3125,479.222656 518.328125,480.238281 518.328125,481.527344 C518.328125,482.210938 518.074219,482.699219 517.234375,483.597656 L510.417969,491 L517.742188,501.019531 C518.699219,502.308594 518.933594,502.855469 518.933594,503.597656 C518.933594,505.082031 517.878906,506.117188 516.355469,506.117188 Z M527.957031,503.402344 C527.957031,505.160156 527.058594,506.195312 525.496094,506.195312 C523.933594,506.195312 523.015625,505.140625 523.015625,503.402344 L523.015625,482.328125 C523.015625,480.238281 523.933594,479.144531 525.730469,479.144531 C527,479.144531 527.742188,479.867188 528.835938,481.488281 L539.070312,497.074219 L539.285156,497.074219 L539.285156,481.9375 C539.285156,480.179688 540.183594,479.144531 541.746094,479.144531 C543.308594,479.144531 544.246094,480.199219 544.246094,481.9375 L544.246094,503.128906 C544.246094,505.121094 543.347656,506.195312 541.667969,506.195312 C540.398438,506.195312 539.65625,505.667969 538.503906,503.929688 L528.171875,488.167969 L527.957031,488.167969 L527.957031,503.402344 Z M558.328125,484.828125 C563.972656,484.828125 567.878906,488.402344 567.878906,494.359375 L567.878906,496.800781 C567.878906,502.953125 563.972656,506.449219 558.328125,506.449219 C552.664062,506.449219 548.757812,502.953125 548.757812,496.820312 L548.757812,494.378906 C548.757812,488.402344 552.664062,484.828125 558.328125,484.828125 Z M558.328125,488.832031 C555.691406,488.832031 554.050781,490.980469 554.050781,494.476562 L554.050781,496.78125 C554.050781,500.316406 555.691406,502.445312 558.328125,502.445312 C561.003906,502.445312 562.585938,500.316406 562.585938,496.78125 L562.585938,494.476562 C562.585938,490.980469 561.003906,488.832031 558.328125,488.832031 Z M585.085938,502.699219 C584.421875,504.828125 581.980469,506.273438 579.011719,506.273438 C574.265625,506.273438 571.277344,502.777344 571.277344,497.191406 L571.277344,494.027344 C571.277344,488.421875 574.285156,484.945312 579.070312,484.945312 C581.960938,484.945312 584.1875,486.234375 584.988281,488.363281 L585.242188,488.363281 L585.242188,480.628906 C585.242188,478.8125 586.160156,477.777344 587.820312,477.777344 C589.460938,477.777344 590.398438,478.8125 590.398438,480.628906 L590.398438,503.363281 C590.398438,505.179688 589.5,506.195312 587.859375,506.195312 C586.355469,506.195312 585.4375,505.277344 585.339844,503.675781 L585.339844,502.699219 L585.085938,502.699219 Z M576.570312,496.664062 C576.570312,500.121094 578.152344,502.171875 580.867188,502.171875 C583.542969,502.171875 585.242188,500.140625 585.242188,496.878906 L585.242188,494.125 C585.242188,491.117188 583.425781,489.066406 580.789062,489.066406 C578.132812,489.066406 576.570312,491.136719 576.570312,494.574219 L576.570312,496.664062 Z M594.773438,496.996094 L594.773438,494.320312 C594.773438,488.65625 598.523438,484.828125 604.089844,484.828125 C609.363281,484.828125 613.09375,488.578125 613.09375,493.695312 C613.09375,496.019531 612.429688,496.78125 610.496094,496.78125 L600.007812,496.78125 L600.007812,497.679688 C600.027344,500.570312 601.863281,502.425781 604.929688,502.425781 C606.53125,502.425781 607.664062,502.035156 608.582031,501.273438 C609.578125,500.511719 609.929688,500.21875 610.730469,500.21875 C611.804688,500.21875 612.546875,500.960938 612.546875,502.09375 C612.546875,503.011719 611.980469,503.890625 611.003906,504.59375 C609.636719,505.746094 607.273438,506.449219 604.597656,506.449219 C598.523438,506.449219 594.773438,502.875 594.773438,496.996094 Z M600.007812,493.519531 L608.171875,493.519531 L608.171875,493.480469 C608.171875,490.648438 606.609375,488.8125 604.167969,488.8125 C601.628906,488.8125 600.007812,490.6875 600.007812,493.480469 L600.007812,493.519531 Z" id="SKNode" fill-rule="nonzero"></path>
            <circle id="Oval-Copy-6" cx="40" cy="492" r="40"></circle>
            <circle id="Oval-Copy-5" cx="204" cy="492" r="40"></circle>
        </g>
    </g>
</svg>


Quando um nó qualquer é criado, o SpriteKit automaticamente organiza a sua cadeia com essa estrutura, e podemos assim criar uma forma de comunicação padronizada entre os nós. Com um objeto base e uma simples extension, nosso nó pode receber um evento e escolher propagar, modificar ou impedir que este evento continue pela cadeia: 

```
@objc class Event: NSObject {}

extension SKNode: EventHandler {
    @objc func handle(event: Event) {
        guard !children.isEmpty else { return }
        children.forEach { $0.handle(event: event) }
    }

    @objc func raise(event: Event) {
        parent?.raise(event: event)
    }
}
```

Com estes dois métodos, quando criarmos um nó qualquer, ele automaticamente propaga o evento passado para baixo ou para cima na cadeia e quando quisermos causar alguma mudança no evento, podemos lidar com eles assim:

```
final class MyNode: SKNode {
    override func handle(event: Event) {
        // lido com os eventos da forma que eu quiser
        super.handle(event: event) // e passo eles pra frente, caso necessário
    }

    override func raise(event: Event) {
        // faço o que quero com meu evento
        super.raise(event: event) // e continuo a propagação do evento para cima na árvore
    }
}
```

Também podemos criar elementos na árvore que não fazem parte do SpriteKit, que não são necessariamente um `SKNode`, para lidar com elementos externos, como uma view do `UIKit`, um objeto que controle o haptic feedback do device pra gente, etc. Para isso, utilizo o protocolo `EventHandler`, que meus `SKNodes` implementam:

```
protocol EventHandler: AnyObject {
    func handle(event: Event)
    func raise(event: Event)
}
```

Agora que temos uma base, podemos começar a criar nossos objetos, eventos e a interação que pode acontecer entre eles. Para começar, estabeleço toda a criação dos nós de UI, da fase e do personagem no começo do ciclo de vida de minha `SKScene`

```    
override func didMove(to view: SKView) {
    setupHandlers()
    setupSpeed()
}

func setupHandlers() {
    let sknodes = [
        UIController(),
        LevelController(),
        PlayerController()
    ]
    sknodes.forEach(addChild)
}

func setupSpeed() {
    handle(event: SpeedEvent(speed: 30))
}
```

Cada evento que será passado pelo sistema é um objeto completo que pode apenas indicar alguma coisa que aconteceu, ou carregar dados adicionais sobre o evento em si, como o `SpeedEvent`, que define a velocidade do jogo, e cada objeto meu lida com ele da forma que desejar:

```
final class SpeedEvent: Event {
    let speed: CGFloat

    init(speed: CGFloat) {
        self.speed = speed
    }
}

// VisibleFloor.swift 
override func handle(event: Event) {
    if let event = event as? SpeedEvent {
        floorSpeed = event.speed
        removeAllActions()
        animateTiles()
    }
}

// EnemyController.swift
override func handle(event: Event) {
    if let event = event as? SpeedEvent {
        floorSpeed = event.speed
        removeAllActions()
        animateEnemies()
    }
}
```

Para lidar com eventos que apenas indicam algum acontecimento no sistema, podemos simplificar o processo:

```
// AudioController.swift
override func handle(event: Event) {
    if event is DeathEvent {
        playDeathSound()
    }
}
```

E por fim, para mostrar a facilidade de se criar objetos que interagem com o sistema como um todo e causam efeitos na cadeia, mesmo que não sejam SKNodes, para adicionar suporte aos controles de Xbox One e PlayStation 4 no nosso jogo, podemos simplesmente adicionar uma classe como esta: 

```
import GameController

final class GameController: EventHandler {

    private weak var parent: EventHandler?
    private var controller: GCController?

    init(parent: EventHandler) {
        self.parent = parent
    }

    func addObservers() {
        NotificationCenter.default.addObserver(self,
                                               selector: #selector(setupInput),
                                               name: .GCControllerDidConnect, 
                                               object: nil)
    }

    @objc func setupInput() {
        self.controller = GCController.controllers().first
        controller?.extendedGamepad?.buttonA.pressedChangedHandler = { [weak self] (_,_, pressed) in
            if pressed {
                self?.raise(event: InteractionEvent(type: .tap))
            }
        }
    }

    func handle(event: Event) {}

    func raise(event: Event) {
        parent?.raise(event: event)
    }

}
```

A talk que fiz tem um hands-on no final que mostra essa arquitetura toda funcionando, incluindo um live code que mostra o quão fácil é incluir novas funcionalidades e criar objetos que interagem com o sistema de forma dinâmica, sem a necessidade de objetos que conhecem uns aos outros diretamente. O projeto completo do jogo pode ser visto no [meu GitHub](https://github.com/loloop/SpriteKitCocoaHeadsES)
